\section{Recursion in \tessla}

Currently, there is no possibility to define a stream recursively, hence with a reference to its previous value. There are two functions \texttt{delay} and \texttt{shift} which are intended for delaying a stream by a certain amount of time or shifting the data values of events of an event stream by a certain number of events. These functions look as if they can be used for recursive stream definitions but in most cases this does not work as expected. This is the reason why functions like \texttt{synchronize}, \texttt{eventCount} or the calculation of a sum by using \texttt{sum} are atomic functions which leads to the problem that a user can not define his own functions when recursive calls are needed for the definition.

To solve this problem, a function \texttt{last} is needed that works quiet similar to \texttt{shift} and \texttt{delay}, but has some important differences. Over event streams the function $\texttt{last}: ùìî_D \rightarrow ùì¢_D$ is defined as follows:
\[\texttt{last}(\eta)(t) = \eta(t') \Leftrightarrow t' \in E(\eta) \land t' < t \land \nexists t' < t'' < t: t'' \in E(\eta)\] 

Over signals the function $\texttt{last}: ùì¢_D \rightarrow ùì¢_D$ is defined as follows:
\[\texttt{last}(\sigma)(t) = \sigma(t') \Leftrightarrow t' \in E(\texttt{changeOf}(\sigma)) \land t' < t \land \nexists t' < t'' < t: t'' \in E(\texttt{changeOf}(\sigma))\] 

This new function allows us to define streams recursively, for example, \texttt{synchronize}, \texttt{eventCount} and \texttt{sum} can be defined as follows:

Count events recursively:
\begin{lstlisting}[language=tessla+salt]
define eventCount(x) := onYield(x, last(eventCount(x)) + 1
\end{lstlisting}

Build a sum recursively:
\begin{lstlisting}[language=tessla+salt]
define sum(x) := onYield(x, last(sum(x))) + mrv(x)
\end{lstlisting}

Build a synchronization recursively:

\begin{lstlisting}[language=tessla+salt]
define diff_x := eventCount(delay(x,2s)) - last(eventCount(err_x)) - 
  (eventCount(y) - last(eventCount(err_y)))
define err_x := filter(on(changeOf(diff_x)), diff_x > 0)

define diff_y := eventCount(delay(y, 2s)) - last(eventCount(err_y)) - 
  (eventCount(x) - last(eventCount(err_x)))
define err_y := filter(on(changeOf(diff_y)), diff_y > 0)

out occurAny(err_x, err_y)
\end{lstlisting}