in x: Events[Int]

-- This differs from counting_map.tessla in that the call to map_get is now
-- nested directly in map_add (and the get_count macro is inlined)
-- In previous versions this nesting caused an error value-related bug to surface.
-- So this is the regression test for that bug.
@liftable
def inc_count(counts: Map[Int, Int], key: Int) :=
    if map_contains(counts, key)
    then map_add(counts, key, map_get(counts, key) + 1)
    else map_add(counts, key, 1)

def counts: Events[Map[Int, Int]] := default(inc_count(last(counts, x), x), map_empty[Int, Int])

out x
out counts